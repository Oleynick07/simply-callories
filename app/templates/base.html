{% load i18n %}
<!DOCTYPE html>
<html lang="{{ LANGUAGE_CODE }}">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>{% trans "Simply Calories" %}</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <style>
    .calorie-input-container {
      position: relative;
      display: inline-block;
      width: 100%;
    }
    
    .calorie-input {
      transition: all 0.3s ease;
    }
    
    .calorie-input.calculator-mode {
      padding-right: 80px;
      font-family: 'Courier New', monospace;
    }
    
    .calorie-preview {
      position: absolute;
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
      color: #28a745;
      font-weight: bold;
      font-size: 0.9em;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    
    .calorie-preview.show {
      opacity: 1;
    }
    
    .calorie-preview.error {
      color: #dc3545;
    }
  </style>
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-light bg-light mb-4">
  <div class="container">
    <a class="navbar-brand" href="/">{% trans "Simply Calories" %}</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarNav">
      <div class="d-flex align-items-center ms-auto">
        <!-- Language Selector -->
        <div class="dropdown me-3">
          <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
            <i class="bi bi-globe"></i> 
            {% get_current_language as CURRENT_LANGUAGE %}
            {% get_available_languages as AVAILABLE_LANGUAGES %}
            {% for lang_code, lang_name in AVAILABLE_LANGUAGES %}
              {% if lang_code == CURRENT_LANGUAGE %}
                {{ lang_name }}
              {% endif %}
            {% endfor %}
          </a>
          <ul class="dropdown-menu">
            {% for lang_code, lang_name in AVAILABLE_LANGUAGES %}
              <li>
                <form method="post" action="{% url 'set_language' %}" style="display: inline;">
                  {% csrf_token %}
                  <input type="hidden" name="language" value="{{ lang_code }}">
                  <button type="submit" class="dropdown-item {% if lang_code == CURRENT_LANGUAGE %}active{% endif %}">
                    {{ lang_name }}
                  </button>
                </form>
              </li>
            {% endfor %}
          </ul>
        </div>
        {% if user.is_authenticated %}
          <span class="navbar-text me-3">{% trans "Hi" %}, {{ user.username }}!</span>
          <form method="post" action="{% url 'logout' %}" style="display: inline;">
            {% csrf_token %}
            <button type="submit" class="btn btn-outline-secondary">{% trans "Logout" %}</button>
          </form>
        {% else %}
          <a class="btn btn-primary me-2" href="/accounts/login/">{% trans "Login" %}</a>
          <a class="btn btn-outline-primary" href="/accounts/signup/">{% trans "Sign up" %}</a>
        {% endif %}
      </div>
    </div>
  </div>
</nav>
<div class="container">
  {% for message in messages %}
    <div class="alert alert-{{ message.tags }}">{{ message }}</div>
  {% endfor %}
  {% block content %}{% endblock %}
</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
// Calculator functionality for calorie inputs
class CalorieCalculator {
  constructor() {
    // Use setTimeout to ensure DOM is fully rendered
    setTimeout(() => {
      this.initializeCalorieInputs();
    }, 100);
  }
  
  initializeCalorieInputs() {
    // Find all calorie input fields - try multiple selectors
    const selectors = [
      'input[name="calories"]',
      'input[id*="calories"]',
      'input[id$="-calories"]',
      '#id_calories'
    ];
    
    let calorieInputs = [];
    selectors.forEach(selector => {
      const inputs = document.querySelectorAll(selector);
      inputs.forEach(input => {
        if (!calorieInputs.includes(input)) {
          calorieInputs.push(input);
        }
      });
    });
    
    console.log('Found calorie inputs:', calorieInputs.length);
    calorieInputs.forEach(input => {
      console.log('Enhancing input:', input);
      this.enhanceCalorieInput(input);
    });
  }
  
  enhanceCalorieInput(input) {
    console.log('Enhancing input:', input.id || input.name);
    
    // Change input type to text to allow arithmetic characters
    if (input.type === 'number') {
      input.type = 'text';
    }
    
    // Wrap input in container if not already wrapped
    if (!input.parentElement.classList.contains('calorie-input-container')) {
      const container = document.createElement('div');
      container.classList.add('calorie-input-container');
      input.parentNode.insertBefore(container, input);
      container.appendChild(input);
      
      // Add preview element
      const preview = document.createElement('span');
      preview.classList.add('calorie-preview');
      container.appendChild(preview);
    }
    
    input.classList.add('calorie-input');
    
    // Add event listeners
    input.addEventListener('input', (e) => this.handleInput(e));
    input.addEventListener('keydown', (e) => this.handleKeydown(e));
    input.addEventListener('blur', (e) => this.handleBlur(e));
    
    console.log('Input enhanced successfully');
  }
  
  handleKeydown(event) {
    const input = event.target;
    const key = event.key;
    
    // Allow: backspace, delete, tab, escape, enter
    if ([8, 9, 27, 13, 46].indexOf(event.keyCode) !== -1 ||
        // Allow: Ctrl+A, Ctrl+C, Ctrl+V, Ctrl+X
        (event.ctrlKey === true && [65, 67, 86, 88].indexOf(event.keyCode) !== -1) ||
        // Allow: home, end, left, right
        (event.keyCode >= 35 && event.keyCode <= 39)) {
      return;
    }
    
    // Only allow: numbers, arithmetic operators, parentheses, space, comma, dot
    const allowedChars = /^[0-9+\-*/.(), ]$/;
    if (!allowedChars.test(key)) {
      event.preventDefault();
    }
    
    // Don't allow space at the beginning
    if (key === ' ' && input.selectionStart === 0) {
      event.preventDefault();
    }
  }
  
  handleInput(event) {
    console.log('Input event:', event.target.value);
    const input = event.target;
    const value = input.value;
    const preview = input.parentElement.querySelector('.calorie-preview');
    
    // Check if value contains arithmetic operators
    const hasArithmetic = /[+\-*/()]/.test(value);
    
    if (hasArithmetic && value.trim()) {
      console.log('Calculator mode activated');
      input.classList.add('calculator-mode');
      const result = this.safeEvaluate(value);
      
      if (result !== null) {
        preview.textContent = `= ${result}`;
        preview.classList.remove('error');
        preview.classList.add('show');
        input.dataset.calculatedValue = result;
      } else {
        preview.textContent = 'Error';
        preview.classList.add('error');
        preview.classList.add('show');
        input.dataset.calculatedValue = '';
      }
    } else {
      input.classList.remove('calculator-mode');
      preview.classList.remove('show');
      input.dataset.calculatedValue = value;
    }
  }
  
  handleBlur(event) {
    const input = event.target;
    const calculatedValue = input.dataset.calculatedValue;
    
    // If there's a calculated value and it's different from input, replace with calculated value
    if (calculatedValue && calculatedValue !== input.value && !isNaN(calculatedValue)) {
      input.value = calculatedValue;
      input.classList.remove('calculator-mode');
      const preview = input.parentElement.querySelector('.calorie-preview');
      preview.classList.remove('show');
    }
  }
  
  safeEvaluate(expression) {
    try {
      // Replace common math symbols and clean the expression
      let cleanExpr = expression
        .replace(/,/g, '.') // Replace commas with dots for decimal
        .replace(/\s+/g, '') // Remove all spaces
        .replace(/[^0-9+\-*/.()]/g, ''); // Remove any invalid characters
      
      console.log('Evaluating:', cleanExpr);
      
      // Basic validation - must contain only allowed characters
      if (!/^[0-9+\-*/.()]+$/.test(cleanExpr)) {
        return null;
      }
      
      // Check for balanced parentheses
      let openParens = 0;
      for (let char of cleanExpr) {
        if (char === '(') openParens++;
        if (char === ')') openParens--;
        if (openParens < 0) return null;
      }
      if (openParens !== 0) return null;
      
      // Use Function constructor instead of eval for safety
      const result = Function('"use strict"; return (' + cleanExpr + ')')();
      
      // Ensure result is a finite number
      if (!isFinite(result) || isNaN(result)) {
        return null;
      }
      
      // Round to reasonable precision
      return Math.round(result * 100) / 100;
    } catch (e) {
      console.error('Evaluation error:', e);
      return null;
    }
  }
}

// Initialize when DOM is ready
document.addEventListener('DOMContentLoaded', () => {
  new CalorieCalculator();
});
</script>
</body>
</html>

