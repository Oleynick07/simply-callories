<!DOCTYPE html>
<html>
<head>
    <title>Calculator Test</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .calorie-input-container {
            position: relative;
            display: inline-block;
            width: 100%;
        }
        
        .calorie-input {
            transition: all 0.3s ease;
        }
        
        .calorie-input.calculator-mode {
            padding-right: 80px;
            font-family: 'Courier New', monospace;
        }
        
        .calorie-preview {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            color: #28a745;
            font-weight: bold;
            font-size: 0.9em;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .calorie-preview.show {
            opacity: 1;
        }
        
        .calorie-preview.error {
            color: #dc3545;
        }
    </style>
</head>
<body>
    <div class="container mt-5">
        <h1>Calculator Test</h1>
        <form>
            <div class="mb-3">
                <label class="form-label">Test Input:</label>
                <input type="number" name="calories" class="form-control" placeholder="Try: 100*2+50">
            </div>
            <div class="mb-3">
                <label class="form-label">Another Test (with ID):</label>
                <input type="number" id="id_calories" class="form-control" placeholder="Try: (100+200)/2">
            </div>
        </form>
    </div>

    <script>
        // Calculator functionality for calorie inputs
        class CalorieCalculator {
            constructor() {
                console.log('CalorieCalculator initialized');
                // Use setTimeout to ensure DOM is fully rendered
                setTimeout(() => {
                    this.initializeCalorieInputs();
                }, 100);
            }
            
            initializeCalorieInputs() {
                // Find all calorie input fields - try multiple selectors
                const selectors = [
                    'input[name="calories"]',
                    'input[id*="calories"]',
                    'input[id$="-calories"]',
                    '#id_calories'
                ];
                
                let calorieInputs = [];
                selectors.forEach(selector => {
                    const inputs = document.querySelectorAll(selector);
                    inputs.forEach(input => {
                        if (!calorieInputs.includes(input)) {
                            calorieInputs.push(input);
                        }
                    });
                });
                
                console.log('Found calorie inputs:', calorieInputs.length);
                calorieInputs.forEach(input => {
                    console.log('Enhancing input:', input);
                    this.enhanceCalorieInput(input);
                });
            }
            
            enhanceCalorieInput(input) {
                console.log('Enhancing input:', input.id || input.name);
                
                // Wrap input in container if not already wrapped
                if (!input.parentElement.classList.contains('calorie-input-container')) {
                    const container = document.createElement('div');
                    container.classList.add('calorie-input-container');
                    input.parentNode.insertBefore(container, input);
                    container.appendChild(input);
                    
                    // Add preview element
                    const preview = document.createElement('span');
                    preview.classList.add('calorie-preview');
                    container.appendChild(preview);
                }
                
                input.classList.add('calorie-input');
                
                // Add event listeners
                input.addEventListener('input', (e) => this.handleInput(e));
                input.addEventListener('keydown', (e) => this.handleKeydown(e));
                input.addEventListener('blur', (e) => this.handleBlur(e));
                
                console.log('Input enhanced successfully');
            }
            
            handleInput(event) {
                console.log('Input event:', event.target.value);
                const input = event.target;
                const value = input.value;
                const preview = input.parentElement.querySelector('.calorie-preview');
                
                // Check if value contains arithmetic operators
                const hasArithmetic = /[+\-*/()]/.test(value);
                
                if (hasArithmetic && value.trim()) {
                    console.log('Calculator mode activated');
                    input.classList.add('calculator-mode');
                    const result = this.safeEvaluate(value);
                    
                    if (result !== null) {
                        preview.textContent = `= ${result}`;
                        preview.classList.remove('error');
                        preview.classList.add('show');
                        input.dataset.calculatedValue = result;
                    } else {
                        preview.textContent = 'Error';
                        preview.classList.add('error');
                        preview.classList.add('show');
                        input.dataset.calculatedValue = '';
                    }
                } else {
                    input.classList.remove('calculator-mode');
                    preview.classList.remove('show');
                    input.dataset.calculatedValue = value;
                }
            }
            
            handleKeydown(event) {
                const input = event.target;
                const key = event.key;
                
                // Allow: backspace, delete, tab, escape, enter
                if ([8, 9, 27, 13, 46].indexOf(event.keyCode) !== -1 ||
                    // Allow: Ctrl+A, Ctrl+C, Ctrl+V, Ctrl+X
                    (event.ctrlKey === true && [65, 67, 86, 88].indexOf(event.keyCode) !== -1) ||
                    // Allow: home, end, left, right
                    (event.keyCode >= 35 && event.keyCode <= 39)) {
                    return;
                }
                
                // Only allow: numbers, arithmetic operators, parentheses, space, comma, dot
                const allowedChars = /^[0-9+\-*/.(), ]$/;
                if (!allowedChars.test(key)) {
                    event.preventDefault();
                }
                
                // Don't allow space at the beginning
                if (key === ' ' && input.selectionStart === 0) {
                    event.preventDefault();
                }
            }
            
            handleBlur(event) {
                const input = event.target;
                const calculatedValue = input.dataset.calculatedValue;
                
                // If there's a calculated value and it's different from input, replace with calculated value
                if (calculatedValue && calculatedValue !== input.value && !isNaN(calculatedValue)) {
                    input.value = calculatedValue;
                    input.classList.remove('calculator-mode');
                    const preview = input.parentElement.querySelector('.calorie-preview');
                    preview.classList.remove('show');
                }
            }
            
            safeEvaluate(expression) {
                try {
                    // Replace common math symbols and clean the expression
                    let cleanExpr = expression
                        .replace(/,/g, '.') // Replace commas with dots for decimal
                        .replace(/\s+/g, '') // Remove all spaces
                        .replace(/[^0-9+\-*/.()]/g, ''); // Remove any invalid characters
                    
                    console.log('Evaluating:', cleanExpr);
                    
                    // Basic validation - must contain only allowed characters
                    if (!/^[0-9+\-*/.()]+$/.test(cleanExpr)) {
                        return null;
                    }
                    
                    // Check for balanced parentheses
                    let openParens = 0;
                    for (let char of cleanExpr) {
                        if (char === '(') openParens++;
                        if (char === ')') openParens--;
                        if (openParens < 0) return null;
                    }
                    if (openParens !== 0) return null;
                    
                    // Use Function constructor instead of eval for safety
                    const result = Function('"use strict"; return (' + cleanExpr + ')')();
                    
                    // Ensure result is a finite number
                    if (!isFinite(result) || isNaN(result)) {
                        return null;
                    }
                    
                    // Round to reasonable precision
                    return Math.round(result * 100) / 100;
                } catch (e) {
                    console.error('Evaluation error:', e);
                    return null;
                }
            }
        }

        // Initialize when DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOM ready, initializing calculator');
            new CalorieCalculator();
        });
    </script>
</body>
</html>
